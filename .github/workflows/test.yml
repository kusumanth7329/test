name: Integration Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [kusu]

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install MySQL (if necessary)
        run: |
          sudo apt-get update
          if ! mysql --version; then
            sudo apt-get install mysql-server -y
            sudo service mysql start
          else
            sudo service mysql status || sudo service mysql start
          fi

      - name: Configure MySQL Database
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.KUSUTRY.databasePassword }}  # Assuming you're using the root user
        run: |
              sudo mysql --user=root --password=${{secrets.KUSUTRY.databasePassword }} -e "CREATE USER IF NOT EXISTS '${{ secrets.KUSUTRY.databaseUser }}'@'localhost' IDENTIFIED BY '${{ secrets.DATABASE_PASSWORD }}';"
              sudo mysql --user=root --password=${{secrets.KUSUTRY.databasePassword }} -e "GRANT ALL PRIVILEGES ON *.* TO '${{ secrets.KUSUTRY.databaseUser }}'@'localhost' WITH GRANT OPTION;"
              sudo mysql --user=root --password=${{secrets.KUSUTRY.databasePassword }}-e "FLUSH PRIVILEGES;"
              sudo mysql --user=root --password=${{secrets.KUSUTRY.databasePassword }} -e "CREATE DATABASE IF NOT EXISTS ${{ secrets.KUSUTRY.databaseName }};"
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20.x'  # Adjust the Node.js version as needed

      - name: Install Dependencies
        run: npm install

      - name: Run Tests
        run: npm test
        env:
          DATABASE_HOST: 127.0.0.1
          DATABASE_USER: ${{ secrets.KUSUTRY.databaseUser }}
          DATABASE_PASSWORD: ${{ secrets.KUSUTRY.databasePassword }}
          DATABASE_NAME: ${{ secrets.KUSUTRY.databaseName }}
          DATABASE_PORT: 3306  # Default MySQL port
